---
title: "NYC Flights"
author: "Coach Skufca"
date: "2022-09-09"
output: html_notebook
---

Time series forecasting.


## Load Packages

```{r}
library(tidyverse)
library(here)
library(janitor)
```



# Homework

## Another source of data - Bureau of Transportation

We will access a much larger data source, with WAY more data, should we want.  But ... we first focus on a particular download goal to get some data which is similar to what we were using.

## YOUR ACTION REQUIRED
 
Go to website  https://www.transtats.bts.gov/DL_SelectFields.aspx?gnoyr_VQ=FIM&QO_fu146_anzr=Nv4%20Pn44vr45 .  This dataset allows access to information on domestic flight and domestic carriers, with monthly summary data.


I want you to download the data for 2019, selecting all fields for download.


![Plot title. ](nyc_class_experiment2_insertimage_1.png)

> Save the download to your data_raw directory. It will be a zipfile, but that will be OK.  Don't change the name of the zipfile.


## Load the BOT data

We take advantage of the `here` package to get the path to the file that we stored.

Load that data into dataframe called `df2019` using the read_csv command.   Note that you do not need to unzip the file.

**NOTE** I use `clean_names` from the janitor package to get names formatted in a consistent and useable way.

```{r}
thisfile=here("data_raw","DL_SelectFields.zip")

df2019=read_csv(thisfile) %>% clean_names()
```

## Subsetting to data of interest

Let's focus on flights from La Guardia (airport "LGA") and eliminate cargo flights by requiring at leat 1 passenger.

Call the resultant dataframe `df9`.

```{r}
df9=df2019 %>% filter(passengers>0,origin=="LGA")

```

We create a barchart as we have done before:

```{r}
df9 %>% ggplot(aes(month)) + geom_bar()
```
By default, `geom_bar` is counting the number of rows, where we asked it to visualize the count by `month`.  

** Take a look at the dataset and discover why counting rows is not going to give us a count of flights. **

The visualization we want is:

```{r}
df9 %>% ggplot(aes(month)) + geom_bar(aes(weight=departures_performed))
```
Make some observations about this plot.


### A new visualization

Can you make a boxplot where the bar height is based on the number of passengers riding each month.




### Just because you can


Here is pretty, but not so useful plot.

```{r}
df9 %>% ggplot(aes(month,fill=carrier_name)) + geom_bar(aes(weight=departures_performed))
```
## Arrivals and departures from LGA

```{r}
df10=df2019 %>% filter(passengers>0,origin=="LGA" | dest=="LGA")

df10 %>% ggplot(aes(month)) + geom_bar(aes(weight=passengers))
```

```{r}
df11=df10 %>% select(month,passengers,seats, carrier_name, dest, origin)

df12=df10 %>% select(1:5, month, contains("id") )

df13=df11 %>% mutate(percent_loading = passengers/seats*100)

df13 %>% ggplot(aes(percent_loading)) +
  geom_histogram()+facet_wrap(~carrier_name,scales="free_y")

```

### Summarize data

```{r}
df15=df2019 %>% filter(passengers>0,origin=="LGA" | dest=="LGA") %>% 
  group_by(month,carrier_name) %>% 
  summarise(total_pass=sum(passengers),  num_flights=sum(departures_performed)) %>%
  mutate(average_pass_per_flight=total_pass/num_flights)


df15 
df15 
```

















```{r}
df15=df2019 %>% filter(passengers>0,origin=="LGA" | dest=="LGA") %>% 
  group_by(month) %>% mutate(percent_loading = passengers/seats*100) %>%
  summarise(loading=mean(percent_loading)) 
```

```{r}
df16=df2019 %>% filter(passengers>0,origin=="LGA" | dest=="LGA") %>% 
  group_by(month,carrier_name) %>% mutate(percent_loading = passengers/seats*100) %>%
  summarise(loading=mean(percent_loading)) 
```

```{r}
df16 %>% ggplot(aes(x=month,y=loading,color=carrier_name))+
  geom_point()+
  theme_minimal()+geom_line()+
  theme(legend.position="bottom")
```

### cargo questions - which airport

```{r}
df17=df2019 %>% filter(origin_city_name=="New York, NY" ) %>% 
  group_by(month,origin) %>% 
  summarise(freight=sum(freight,na.rm = FALSE),passengers=sum(passengers),n=n()) 
df17
```



## time series

```{r}
t=0:20
y=2.5*t+rnorm(n=21)

dft=tibble(t,y)
```


```{r}
dft %>% ggplot(aes(t,y))+geom_point()
```
```{r}
lm(y~t,data=dft) %>% summary()
```

```{r}
dft_1=dft %>% mutate(yd=lag(y)) %>% relocate(yd,.before = y)
```

```{r}
lm(y~yd,data=dft_1) %>% summary()
```

```{r}
dft_2=dft_1 %>% mutate(yd2=lag(yd)) %>% relocate(yd2,.before = y)
lm(y~yd+yd2,data=dft_2) %>% summary()
```

## expontential growth


```{r}
t=0:20
y=exp(.2*t)+rnorm(n=21)

dft=tibble(t,y)
```


```{r}
dft %>% ggplot(aes(t,y))+geom_point()
```
```{r}
lm(y~t,data=dft) %>% summary()
```

```{r}
dft_1=dft %>% mutate(yd=lag(y)) %>% relocate(yd,.before = y)
```

```{r}
lm(y~yd,data=dft_1) %>% summary()
```

```{r}
dft_2=dft_1 %>% mutate(yd2=lag(yd)) %>% relocate(yd2,.before = y)
lm(y~yd+yd2,data=dft_2) %>% summary()
```


```{r}
library(forecast)

```

```{r}
t=0:40
y=2.5*t+rnorm(n=41)+10*sin(2*pi*t/20)
tsdata=ts(y,start=0,frequency=5)
```


```{r}
ddata <- decompose(tsdata, "multiplicative")

plot(ddata)
```

